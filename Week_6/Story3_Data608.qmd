---
title: "Story3_Data608"
author: "Mubashira Qari"
date: 2025-2-23"
format: revealjs
editor: visual
---

```{r, warning=FALSE}


library(dplyr)
library(tidyverse)
library(readxl)
library(ggplot2)
library(dplyr)
library(stringr)
library(tools)
library(stringdist)
library(broom)
library(gridExtra)
library(gclus)
library(car)
library(VGAM)
library(MASS)
library(rpart.plot)
library(ggfortify)
library(gridExtra)
library(forecast)
library(fpp2)
library(fma)
library(kableExtra)
library(e1071)
library(mlbench)
library(ggcorrplot)
library(DataExplorer)
library(timeDate)
library(caret)
library(GGally)
library(corrplot)
library(RColorBrewer)
library(tibble)
library(tidyr)
library(reshape2)
library(mixtools)
library(skimr)
library(ggplot2)
library(dplyr)
library(usmap)   # For U.S. map plotting
library(sf)      # For spatial data handling 
library(viridis) # For color scales


# Loading Dataset

# Code book: https://brightspace.cuny.edu/content/enforced/680560-SPS01_DATA_608_1252_18469/37363-0001-Codebook-ICPSR.pdf

firearm_mortality_df <- read.csv("https://raw.githubusercontent.com/uzmabb182/Data_608/refs/heads/main/Week_6/State_Overview-2019-2023.csv")

firearm_laws_df <- read.csv("https://raw.githubusercontent.com/uzmabb182/Data_608/refs/heads/main/Week_6/firearm_laws.csv")

gun_deaths_by_demographics_df <- read.csv("https://raw.githubusercontent.com/uzmabb182/Data_608/refs/heads/main/Week_6/Gun_Deaths_by_Demographics-2019-2023.csv")

# firearm_mortality_data <- read.csv("https://raw.githubusercontent.com/uzmabb182/Data_608/refs/heads/main/Week_6/firearm_mortality2022.csv")

state_abbreviation_df <- read.csv("https://raw.githubusercontent.com/uzmabb182/Data_608/refs/heads/main/Week_6/states_abbreviations.csv")
#gun_deaths_by_demographics_df
```



```{r}
### Preparing for API Call Census 2010 Data
Sys.setenv(census_api_key = "f7ce5a76ddf2088c73fda9c0a87410995cebbffa")
#Sys.getenv("census_api_key")
```


```{r}
# Access the API key
# Save the Census API key in the environmental variable.
#census_api_key("YOUR KEY GOES HERE", install = TRUE)
```


```{r}
#Sys.getenv("census_api_key")
```


```{r}
# Fetching Census Data for the year 2020
# https://api.census.gov/data/2020/acs/acs1?get=NAME,B01001_001E&for=state:*
# Load required packages

library(tidycensus)
library(dplyr)

census_df <- get_acs(
  geography = "state",
  variables = c(population = "B01003_001E",
                median_age = "B01002_001E",
                household_income = "B19013_001E",
                per_capita_income = "B19301_001E",
                poverty_count = "B17001_002E",
                unemployment_count = "B23025_005E"
                ),
  output = "wide",
  year = 2020
)

#head(census_df)
# View the actual column names in census_df
colnames(census_df)

```



```{r}
library(dplyr)


#census_df <- census_df %>% select(
#  NAME, population, median_age, household_income, per_capita_income, 
#  poverty_count, unemployment_count
#)
#required_columns <- c("NAME", "population", "median_age", "household_income", 
#                      "per_capita_income", "poverty_count", "unemployment_count")

#census_df <- census_df %>% select(all_of(required_columns))


# Print first few rows to verify
head(census_df)


# Capitalize first letter of each column name
names(census_df) <- tools::toTitleCase(tolower(names(census_df)))

# View the dataframe
head(census_df)


```



```{r}

# Replacing value 'District of Columbia' by 'DC '
#firearm_mortality_df$STATE <- gsub("District of Columbia", "DC", firearm_mortality_df$STATE)


# Keeps all rows from firearm_mortality_data and fills in NA for missing matches in state_abbreviation
firearm_mortality_df <- firearm_mortality_df %>%
  left_join(state_abbreviation_df, by = c("State" = "State"))

gun_deaths_by_demographics_df <- gun_deaths_by_demographics_df %>%
  left_join(state_abbreviation_df, by = c("State" = "State"))


#firearm_mortality_df
#gun_deaths_by_demographics_df


```


```{r}

# Remove "United States" row if present
gun_deaths_by_demographics_df <- gun_deaths_by_demographics_df %>% filter(State != "UNITED STATES")

gun_deaths_by_demographics_df <- gun_deaths_by_demographics_df %>%
  left_join(census_df, by = c("State" = "Name"))



gun_deaths_by_demographics_df <- gun_deaths_by_demographics_df %>%
  left_join(firearm_laws_df, by = c("State" = "STATE"))


library(dplyr)

# Remove rows where "column_name" is NA
gun_deaths_by_demographics_df <- gun_deaths_by_demographics_df %>%
  filter(!is.na(Total.Deaths....))

gun_deaths_by_demographics_df$Population <- as.integer(gun_deaths_by_demographics_df$Population)
gun_deaths_by_demographics_df$Poverty_count <- as.integer(gun_deaths_by_demographics_df$Poverty_count)
gun_deaths_by_demographics_df$Unemployment_count <- as.integer(gun_deaths_by_demographics_df$Unemployment_count)
#str(gun_deaths_by_demographics_df)

gun_deaths_by_demographics_df <- mutate(gun_deaths_by_demographics_df, per100k_population_poverty = (Poverty_count/Population)*100000)
#gun_deaths_by_demographics_df <- mutate(gun_deaths_by_demographics_df, per_capita_unemployment = (Unemployment_count/Population)*100)
#gun_deaths_by_demographics_df <- mutate(gun_deaths_by_demographics_df, per_capita_death = (Total.Deaths..../Population)*100)

#gun_deaths_by_demographics_df

```


```{r}
library(tidyverse)

# Ensure `per100k_population_death` exists and remove missing values
clean_data <- gun_deaths_by_demographics_df %>%
  drop_na(Total.Deaths...., Population, LAWTOTAL) %>%
  mutate(per100k_population_death = (Total.Deaths.... / Population) * 100000)  # Compute deaths per 100k

```

## Gun Laws (LAWTOTAL) vs. Firearm Deaths (per100k_population_death)

-   This scatter plot will shows that states with more gun laws have lower firearm death rates.
-   The red regression line trends downward, it suggests that more gun laws lead to fewer firearm deaths.

```{r}
ggplot(clean_data, aes(x = LAWTOTAL, y = per100k_population_death)) +
  geom_point(size = 4, alpha = 0.7, color = "blue") +  
  geom_smooth(method = "lm", se = TRUE, linetype = "dashed", color = "red") +  
  theme_minimal(base_size = 14) +  
  labs(title = "More Gun Laws have Lower Firearm Death Rates",
       x = "Total Gun Laws (LAWTOTAL)",
       y = "Firearm Deaths per 100k Population")  



```
## Firearm Deaths by PERMITH (Handgun Permit Laws)

-   This compares firearm deaths in states that require a handgun permit (PERMITH = 1) vs. those that don't (PERMITH = 0).
-   PERMITH = 1 has a lower median death rate, it suggests that handgun permit laws reduce firearm deaths.

```{r}
ggplot(clean_data, aes(x = factor(PERMITH), y = per100k_population_death, fill = factor(PERMITH))) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
  scale_fill_manual(values = c("red", "blue"), name = "Handgun Permit") +
  labs(title = "Handgun Permit Laws Reduce Firearm Deaths",
       x = "Handgun Permit Required (0 = No, 1 = Yes)",
       y = "Firearm Deaths per 100k Population")

```
## Analyzing the correlation between poverty and firearm deaths:

-   The scatter plot below shows a strong positive correlation between per100k_population_poverty and firearm deaths.
-   States with higher poverty levels tend to experience more gun-related fatalities, suggesting that economic hardship contributes to gun violence.

```{r}
# Load required libraries
library(ggplot2)
library(dplyr)

# Check if required columns exist
required_columns <- c("per100k_populationa_death", "per100k_population_poverty")
missing_columns <- setdiff(required_columns, colnames(gun_deaths_by_demographics_df))


# Convert columns to numeric (if necessary)
#gun_deaths_by_demographics_df <- gun_deaths_by_demographics_df %>%
#  mutate(across(c(per100k_population_death, per100k_population_poverty), as.numeric))


# Create a scatter plot with trend line
ggplot(clean_data, aes(x = per100k_population_poverty, y = per100k_population_death)) +
  geom_point(aes(color = per100k_population_poverty), size = 3, alpha = 0.7) +  # Scatter plot points
  geom_smooth(method = "lm", se = FALSE, color = "black", linetype = "dashed", size = 1.2) +  # Regression line
  scale_color_gradient(low = "blue", high = "red") +  # Color scale
  theme_minimal(base_size = 14) +
  labs(title = "Firearm Deaths vs Poverty",
       subtitle = "Strong Positive Correlation between Poverty and Firearm Deaths",
       x = "Per 100K Population Poverty",
       y = "Firearm Deaths per 100K Population",
       color = "Poverty Level") +
  theme(
    panel.grid.major = element_line(color = "gray85"),
    panel.grid.minor = element_blank(),
    legend.position = "right"
  )


```
## The Regression Model Interpretation:

-   The regression model and scatter plots confirm that states with stricter gun laws (higher LAWTOTAL scores) tend to have lower firearm death rates.
-   States requiring handgun permits (PERMITH = 1) show fewer deaths, while states without permit requirements see higher firearm mortality.

## Permit Laws and Gun-Related Death Rates – A Potential Protective Effect?

-   The boxplot visualizes the relationship between permit laws (PERMITLAW: 0 = No, 1 = Yes) and death rates per 100k population.

```{r}
# Load necessary library
library(ggplot2)

# Ensure PERMITLAW is a factor (categorical)
clean_data$PERMITLAW <- as.factor(clean_data$PERMITLAW)

# Boxplot with jittered points
ggplot(clean_data, aes(x = PERMITLAW, y = per100k_population_death, fill = PERMITLAW)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.5) +  # Boxplot with transparent fill
  geom_jitter(aes(color = PERMITLAW), width = 0.2, alpha = 0.6, size = 2) +  # Jittered points
  labs(
    title = "Impact of Permit Laws on Death Rates",
    subtitle = "Permit Laws and Gun-Related Death Rates – A Potential Protective Effect?",
    x = "Permit Law (0 = No, 1 = Yes)",
    y = "Death Rate per 100k Population"
  ) +
  scale_fill_manual(values = c("#F8766D", "#00BFC4")) +  # Fix color mapping
  scale_color_manual(values = c("#F8766D", "#00BFC4")) +  # Fix jitter colors
  theme_minimal() +
  theme(legend.position = "none")  # Remove redundant legend


```
### Interpretation of the Boxplot

 Here's what we can infer from the chart:

-   Median Death Rates
The central line inside each box represents the median (middle value).
If the median for PERMITLAW = 1 (states with permit laws) is lower than for PERMITLAW = 0, this suggests that permit laws might be associated with lower death rates.
Conversely, if they are similar, it suggests no strong association.

-  Spread of Data (Interquartile Range, IQR)
The height of each box represents the middle 50% of data (IQR).
If PERMITLAW = 0 has a larger spread, it suggests more variation in death rates in states without permit laws.
A smaller spread for PERMITLAW = 1 could indicate that states with permit laws have more consistent (and possibly lower) death rates.

-  Outliers & Individual Data Points
The jittered points (dots) represent individual states.
If many high death rate outliers appear in the PERMITLAW = 0 group, it suggests that states without permit laws might experience more extreme cases of high gun-related deaths.

- General Trend
If the entire PERMITLAW = 1 box is lower than PERMITLAW = 0, it strongly suggests that states with permit laws tend to have lower death rates.
If the boxes overlap significantly, it suggests no strong difference in death rates between the two groups.

